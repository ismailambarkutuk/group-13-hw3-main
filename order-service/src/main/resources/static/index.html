<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Group-13 | Online Shopping (Microservices Demo)</title>
    <style>
        :root{
            --bg:#0b1220;
            --card:#111b2e;
            --card2:#0f1728;
            --text:#e6edf7;
            --muted:#9fb0cf;
            --accent:#4fd1c5;
            --accent2:#60a5fa;
            --danger:#fb7185;
            --warn:#fbbf24;
            --ok:#34d399;
            --line:rgba(255,255,255,.08);
            --shadow: 0 14px 40px rgba(0,0,0,.35);
            --radius: 18px;
            --radius2: 14px;
            --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
        }
        *{box-sizing:border-box}
        body{
            margin:0;
            font-family:var(--sans);
            background:
                    radial-gradient(1200px 600px at 15% -10%, rgba(79,209,197,.22), transparent 60%),
                    radial-gradient(1000px 600px at 90% 0%, rgba(96,165,250,.18), transparent 55%),
                    radial-gradient(900px 600px at 50% 120%, rgba(251,113,133,.12), transparent 55%),
                    var(--bg);
            color:var(--text);
        }
        a{color:inherit}
        .wrap{
            max-width:1200px;
            margin:0 auto;
            padding:24px 16px 48px;
        }
        header{
            display:flex;
            align-items:flex-start;
            justify-content:space-between;
            gap:16px;
            margin-bottom:18px;
        }
        .title{
            display:flex; flex-direction:column; gap:6px;
        }
        .title h1{
            margin:0;
            font-size:28px;
            letter-spacing:.2px;
        }
        .title p{
            margin:0;
            color:var(--muted);
            line-height:1.4;
            max-width:780px;
        }
        .pillRow{
            display:flex; flex-wrap:wrap; gap:8px;
            margin-top:10px;
        }
        .pill{
            border:1px solid var(--line);
            background:rgba(255,255,255,.03);
            padding:7px 10px;
            border-radius:999px;
            font-size:12px;
            color:var(--muted);
        }
        .grid{
            display:grid;
            grid-template-columns: 1.2fr .8fr;
            gap:14px;
        }
        @media (max-width: 980px){
            .grid{grid-template-columns:1fr}
            header{flex-direction:column}
        }
        .card{
            background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
            border:1px solid var(--line);
            border-radius:var(--radius);
            box-shadow:var(--shadow);
            overflow:hidden;
        }
        .cardHead{
            padding:14px 16px;
            border-bottom:1px solid var(--line);
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:10px;
            background:rgba(255,255,255,.02);
        }
        .cardHead h2{
            margin:0;
            font-size:15px;
            letter-spacing:.2px;
        }
        .cardBody{padding:14px 16px}
        .row{
            display:flex;
            align-items:center;
            gap:10px;
            flex-wrap:wrap;
        }
        .rowBetween{
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:10px;
            flex-wrap:wrap;
        }
        .btn{
            appearance:none;
            border:1px solid var(--line);
            background:rgba(255,255,255,.03);
            color:var(--text);
            padding:10px 12px;
            border-radius:12px;
            cursor:pointer;
            transition: transform .06s ease, background .15s ease, border-color .15s ease;
            font-weight:600;
            letter-spacing:.2px;
            font-size:13px;
        }
        .btn:hover{background:rgba(255,255,255,.06); border-color:rgba(255,255,255,.16)}
        .btn:active{transform:translateY(1px)}
        .btnPrimary{
            border-color:rgba(79,209,197,.35);
            background:rgba(79,209,197,.12);
        }
        .btnPrimary:hover{background:rgba(79,209,197,.18)}
        .btnDanger{
            border-color:rgba(251,113,133,.35);
            background:rgba(251,113,133,.10);
        }
        .btnGhost{background:transparent}
        .input, .select{
            padding:10px 12px;
            border-radius:12px;
            border:1px solid var(--line);
            background:rgba(0,0,0,.18);
            color:var(--text);
            outline:none;
            font-size:13px;
        }
        .input::placeholder{color:rgba(159,176,207,.7)}
        .badge{
            display:inline-flex;
            align-items:center;
            gap:8px;
            padding:8px 10px;
            border-radius:999px;
            border:1px solid var(--line);
            background:rgba(0,0,0,.18);
            font-size:12px;
            color:var(--muted);
        }
        .dot{
            width:9px; height:9px; border-radius:50%;
            background:rgba(255,255,255,.18);
            box-shadow:0 0 0 4px rgba(255,255,255,.05);
        }
        .dot.ok{background:var(--ok); box-shadow:0 0 0 4px rgba(52,211,153,.12)}
        .dot.warn{background:var(--warn); box-shadow:0 0 0 4px rgba(251,191,36,.12)}
        .dot.bad{background:var(--danger); box-shadow:0 0 0 4px rgba(251,113,133,.12)}

        .products{
            display:grid;
            grid-template-columns: repeat(3, 1fr);
            gap:12px;
        }
        @media (max-width: 980px){
            .products{grid-template-columns:repeat(2,1fr)}
        }
        @media (max-width: 520px){
            .products{grid-template-columns:1fr}
        }
        .pCard{
            border:1px solid var(--line);
            border-radius:var(--radius2);
            background:rgba(0,0,0,.18);
            overflow:hidden;
            display:flex;
            flex-direction:column;
            min-height:150px;
        }
        .pTop{
            padding:12px 12px 8px;
            display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
        }
        .pName{
            font-weight:800; letter-spacing:.2px;
            margin:0 0 4px 0;
            font-size:14px;
        }
        .pMeta{
            color:var(--muted);
            font-size:12px;
            margin:0;
        }
        .pPrice{
            font-family:var(--mono);
            color:var(--accent2);
            font-weight:800;
            font-size:13px;
            white-space:nowrap;
        }
        .pBottom{
            margin-top:auto;
            padding:10px 12px 12px;
            display:flex;
            gap:8px;
            justify-content:space-between;
            align-items:center;
            border-top:1px solid var(--line);
            background:rgba(255,255,255,.02);
        }

        .cartList{
            display:flex;
            flex-direction:column;
            gap:10px;
        }
        .cartItem{
            border:1px solid var(--line);
            border-radius:14px;
            background:rgba(0,0,0,.18);
            padding:10px 12px;
        }
        .cartItem .name{font-weight:800; margin:0; font-size:13px}
        .cartItem .sub{margin:4px 0 0; color:var(--muted); font-size:12px}
        .qtyRow{
            margin-top:10px;
            display:flex; align-items:center; justify-content:space-between; gap:8px;
        }
        .qtyBtns{display:flex; gap:6px; align-items:center}
        .qty{
            font-family:var(--mono);
            padding:6px 10px;
            border:1px solid var(--line);
            border-radius:10px;
            background:rgba(255,255,255,.03);
        }
        .miniBtn{
            padding:7px 10px;
            border-radius:10px;
            font-size:12px;
        }

        pre{
            margin:0;
            padding:12px;
            border-radius:14px;
            border:1px solid var(--line);
            background:rgba(0,0,0,.22);
            overflow:auto;
            max-height:290px;
            font-family:var(--mono);
            font-size:12px;
            color:#cfe2ff;
        }
        .muted{color:var(--muted)}
        .kpi{
            display:grid;
            grid-template-columns: repeat(3,1fr);
            gap:10px;
            margin-top:12px;
        }
        .k{
            border:1px solid var(--line);
            border-radius:14px;
            padding:10px 12px;
            background:rgba(0,0,0,.18);
        }
        .k .label{color:var(--muted); font-size:12px}
        .k .val{font-family:var(--mono); font-weight:800; font-size:13px; margin-top:6px}
        .toast{
            position:fixed;
            right:16px;
            bottom:16px;
            width:min(420px, calc(100% - 32px));
            display:flex;
            flex-direction:column;
            gap:10px;
            pointer-events:none;
            z-index:50;
        }
        .toastItem{
            pointer-events:auto;
            border:1px solid var(--line);
            border-radius:14px;
            background:rgba(17,27,46,.92);
            box-shadow:var(--shadow);
            padding:10px 12px;
            display:flex;
            gap:10px;
            align-items:flex-start;
            animation: pop .18s ease-out;
        }
        @keyframes pop{from{transform:translateY(8px);opacity:.3}to{transform:translateY(0);opacity:1}}
        .toastItem .tTitle{margin:0; font-weight:900; font-size:13px}
        .toastItem .tMsg{margin:2px 0 0; color:var(--muted); font-size:12px; line-height:1.35}
        .toastIcon{
            width:10px;height:10px;border-radius:50%;
            margin-top:6px;
        }
        .toastIcon.ok{background:var(--ok)}
        .toastIcon.warn{background:var(--warn)}
        .toastIcon.bad{background:var(--danger)}
    </style>
</head>
<body>
<div class="wrap">
    <header>
        <div class="title">
            <h1>Online Shopping System ‚Äî Microservices Demo (Group-13)</h1>
            <p>
                This UI demonstrates a simplified microservices flow. Products are served by <b>Product Service</b>,
                orders are created in <b>Order Service</b>, and payments are processed by <b>Payment Service</b>.
            </p>
            <div class="pillRow">
                <span class="pill">Product Service: :8082</span>
                <span class="pill">Order Service: :8083</span>
                <span class="pill">Payment Service: :8084</span>
                <span class="pill">Pattern: Microservices</span>
            </div>
        </div>

        <div class="row">
            <span class="badge"><span id="dotProduct" class="dot"></span> Product</span>
            <span class="badge"><span id="dotOrder" class="dot"></span> Order</span>
            <span class="badge"><span id="dotPayment" class="dot"></span> Payment</span>
            <button class="btn btnPrimary" onclick="checkServices()">Check Services</button>
        </div>
    </header>

    <div class="grid">
        <!-- LEFT: PRODUCTS + RESULT -->
        <section class="card">
            <div class="cardHead">
                <h2>Products</h2>
                <div class="row">
                    <input id="search" class="input" placeholder="Search product name‚Ä¶" oninput="renderProducts()"/>
                    <select id="sort" class="select" onchange="renderProducts()">
                        <option value="nameAsc">Sort: Name (A‚ÜíZ)</option>
                        <option value="priceAsc">Sort: Price (Low‚ÜíHigh)</option>
                        <option value="priceDesc">Sort: Price (High‚ÜíLow)</option>
                    </select>
                    <select id="priceFilter" class="select" onchange="renderProducts()">
                        <option value="all">Filter: All Prices</option>
                        <option value="0-1000">0 ‚Äì 1000</option>
                        <option value="1000-3000">1000 ‚Äì 3000</option>
                        <option value="3000+">3000+</option>
                    </select>
                    <button class="btn" onclick="loadProducts()">Reload</button>
                </div>
            </div>
            <div class="cardBody">
                <div id="products" class="products"></div>

                <div class="kpi">
                    <div class="k">
                        <div class="label">Products loaded</div>
                        <div class="val" id="kProducts">0</div>
                    </div>
                    <div class="k">
                        <div class="label">Cart items</div>
                        <div class="val" id="kCart">0</div>
                    </div>
                    <div class="k">
                        <div class="label">Cart total (‚Ç∫)</div>
                        <div class="val" id="kTotal">0</div>
                    </div>
                </div>
            </div>

            <div class="cardHead">
                <h2>Order & Payment Result</h2>
                <div class="row">
                    <button class="btn btnGhost" onclick="clearResult()">Clear</button>
                </div>
            </div>
            <div class="cardBody">
                <p class="muted" style="margin-top:0">
                    ‚ÄúPlace Order‚Äù triggers <span style="font-family:var(--mono)">POST /orders</span> on Order Service.
                    Order Service then calls Payment Service and returns a combined response.
                </p>
                <pre id="result">{}</pre>
            </div>
        </section>

        <!-- RIGHT: CART + ACTIONS + HISTORY -->
        <aside class="card">
            <div class="cardHead">
                <h2>Cart</h2>
                <div class="row">
                    <button class="btn btnDanger" onclick="clearCart()">Clear Cart</button>
                </div>
            </div>
            <div class="cardBody">
                <div id="cart" class="cartList"></div>

                <div style="margin-top:12px" class="rowBetween">
                    <div>
                        <div class="muted" style="font-size:12px">Total</div>
                        <div style="font-family:var(--mono); font-weight:900; font-size:16px" id="cartTotal">‚Ç∫0</div>
                    </div>
                    <button class="btn btnPrimary" onclick="placeOrder()">Place Order</button>
                </div>

                <div style="margin-top:10px" class="muted">
                    Tip: Payment is randomized (success/fail). If it fails, try again ‚Äî just like real life‚Ä¶ but cheaper. üòÑ
                </div>
            </div>

            <div class="cardHead">
                <h2>Order History</h2>
                <div class="row">
                    <button class="btn" onclick="clearHistory()">Clear</button>
                </div>
            </div>
            <div class="cardBody">
                <pre id="history">[]</pre>
            </div>
        </aside>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
    // ---- Service endpoints (local demo) ----
    const PRODUCT_URL = "http://localhost:8082/products";
    const ORDER_URL   = "http://localhost:8083/orders";
    const PAYMENT_URL = "http://localhost:8084/payments/pay";

    // ---- State ----
    let products = [];
    const cart = new Map(); // id -> {id,name,price,qty}
    const history = [];

    // ---- Helpers ----
    function fmtTRY(n){
        const x = Number(n) || 0;
        return "‚Ç∫" + x.toLocaleString("tr-TR");
    }

    function toast(type, title, msg){
        const box = document.getElementById("toast");
        const el = document.createElement("div");
        el.className = "toastItem";
        const icon = document.createElement("div");
        icon.className = "toastIcon " + (type || "ok");
        const t = document.createElement("div");
        t.innerHTML = `<p class="tTitle">${title}</p><p class="tMsg">${msg}</p>`;
        el.appendChild(icon);
        el.appendChild(t);
        box.appendChild(el);
        setTimeout(()=>{ el.style.opacity = "0"; el.style.transform = "translateY(6px)"; }, 2400);
        setTimeout(()=>{ el.remove(); }, 2800);
    }

    function setDot(id, status){
        const dot = document.getElementById(id);
        dot.classList.remove("ok","warn","bad");
        if(status === "ok") dot.classList.add("ok");
        else if(status === "warn") dot.classList.add("warn");
        else if(status === "bad") dot.classList.add("bad");
    }

    function setResult(obj){
        document.getElementById("result").textContent = JSON.stringify(obj, null, 2);
    }

    function setHistory(){
        document.getElementById("history").textContent = JSON.stringify(history, null, 2);
    }

    function updateKpis(){
        document.getElementById("kProducts").textContent = products.length;
        document.getElementById("kCart").textContent = [...cart.values()].reduce((a,i)=>a+i.qty,0);
        document.getElementById("kTotal").textContent = (calcTotal()).toLocaleString("tr-TR");
        document.getElementById("cartTotal").textContent = fmtTRY(calcTotal());
    }

    function calcTotal(){
        let sum = 0;
        for(const item of cart.values()){
            sum += (Number(item.price) || 0) * (Number(item.qty) || 0);
        }
        return sum;
    }

    // ---- Products ----
    async function loadProducts(){
        try{
            const res = await fetch(PRODUCT_URL);
            if(!res.ok) throw new Error("Product service responded with " + res.status);
            products = await res.json();
            toast("ok","Products loaded","Fetched products from Product Service.");
            setDot("dotProduct","ok");
            renderProducts();
        }catch(e){
            setDot("dotProduct","bad");
            toast("bad","Product Service error", String(e.message || e));
            document.getElementById("products").innerHTML =
                `<div class="muted">Could not load products. Make sure Product Service is running on :8082.</div>`;
            updateKpis();
        }
    }

    function renderProducts(){
        const root = document.getElementById("products");
        const q = (document.getElementById("search").value || "").toLowerCase().trim();
        const sort = document.getElementById("sort").value;
        const pf = document.getElementById("priceFilter").value;

        let list = [...products];

        // filter by search
        if(q){
            list = list.filter(p => String(p.name || "").toLowerCase().includes(q));
        }

        // filter by price
        list = list.filter(p=>{
            const price = Number(p.price) || 0;
            if(pf === "all") return true;
            if(pf === "0-1000") return price >= 0 && price <= 1000;
            if(pf === "1000-3000") return price > 1000 && price <= 3000;
            if(pf === "3000+") return price > 3000;
            return true;
        });

        // sort
        if(sort === "nameAsc"){
            list.sort((a,b)=>String(a.name).localeCompare(String(b.name)));
        }else if(sort === "priceAsc"){
            list.sort((a,b)=>(Number(a.price)||0) - (Number(b.price)||0));
        }else if(sort === "priceDesc"){
            list.sort((a,b)=>(Number(b.price)||0) - (Number(a.price)||0));
        }

        if(list.length === 0){
            root.innerHTML = `<div class="muted">No products found for current filters.</div>`;
            updateKpis();
            return;
        }

        root.innerHTML = "";
        for(const p of list){
            const el = document.createElement("div");
            el.className = "pCard";
            el.innerHTML = `
          <div class="pTop">
            <div>
              <p class="pName">${escapeHtml(p.name)}</p>
              <p class="pMeta">ID: <span style="font-family:var(--mono)">${escapeHtml(p.id)}</span></p>
            </div>
            <div class="pPrice">${fmtTRY(p.price)}</div>
          </div>
          <div class="pBottom">
            <button class="btn miniBtn" onclick="addToCart('${escapeJs(p.id)}')">Add to Cart</button>
            <button class="btn miniBtn btnGhost" onclick="quickBuy('${escapeJs(p.id)}')">Quick Buy</button>
          </div>
        `;
            root.appendChild(el);
        }
        updateKpis();
    }

    function addToCart(id){
        const p = products.find(x => x.id === id);
        if(!p){ toast("warn","Not found","Product not found in local list."); return; }
        const existing = cart.get(id);
        if(existing) existing.qty += 1;
        else cart.set(id, { id:p.id, name:p.name, price:Number(p.price)||0, qty:1 });
        toast("ok","Added to cart", `${p.name} added.`);
        renderCart();
    }

    function quickBuy(id){
        cart.clear();
        addToCart(id);
        placeOrder();
    }

    // ---- Cart ----
    function renderCart(){
        const root = document.getElementById("cart");
        root.innerHTML = "";

        if(cart.size === 0){
            root.innerHTML = `<div class="muted">Cart is empty. Add products to place an order.</div>`;
            updateKpis();
            return;
        }

        for(const item of cart.values()){
            const el = document.createElement("div");
            el.className = "cartItem";
            el.innerHTML = `
          <p class="name">${escapeHtml(item.name)}</p>
          <p class="sub">
            <span style="font-family:var(--mono)">${escapeHtml(item.id)}</span>
            ‚Ä¢ ${fmtTRY(item.price)} each
          </p>
          <div class="qtyRow">
            <div class="qtyBtns">
              <button class="btn miniBtn" onclick="decQty('${escapeJs(item.id)}')">-</button>
              <span class="qty">${item.qty}</span>
              <button class="btn miniBtn" onclick="incQty('${escapeJs(item.id)}')">+</button>
            </div>
            <div style="font-family:var(--mono); font-weight:900">${fmtTRY(item.price * item.qty)}</div>
          </div>
        `;
            root.appendChild(el);
        }

        updateKpis();
    }

    function incQty(id){
        const item = cart.get(id);
        if(!item) return;
        item.qty += 1;
        renderCart();
    }

    function decQty(id){
        const item = cart.get(id);
        if(!item) return;
        item.qty -= 1;
        if(item.qty <= 0) cart.delete(id);
        renderCart();
    }

    function clearCart(){
        cart.clear();
        toast("warn","Cart cleared","All items removed from cart.");
        renderCart();
    }

    // ---- Order ----
    async function placeOrder(){
        try{
            setDot("dotOrder","warn");

            // NOTE: Backend /orders currently ignores request body. We still send it for a nicer demo.
            const payload = {
                items: [...cart.values()],
                totalAmount: calcTotal()
            };

            const res = await fetch(ORDER_URL, {
                method: "POST",
                headers: { "Content-Type":"application/json" },
                body: JSON.stringify(payload)
            });

            if(!res.ok) throw new Error("Order service responded with " + res.status);

            const data = await res.json();
            setResult(data);

            // Update status dots based on response
            setDot("dotOrder","ok");
            const payStatus = data?.payment?.status;
            if(payStatus === "SUCCESS") setDot("dotPayment","ok");
            else if(payStatus === "FAILED") setDot("dotPayment","bad");
            else setDot("dotPayment","warn");

            // Add to history
            history.unshift({
                at: new Date().toISOString(),
                cart: payload,
                response: data
            });
            if(history.length > 8) history.pop();
            setHistory();

            const finalStatus = data?.order?.status || "UNKNOWN";
            toast(finalStatus === "PAID" ? "ok" : "warn", "Order completed", `Order status: ${finalStatus}`);

        }catch(e){
            setDot("dotOrder","bad");
            toast("bad","Order error", String(e.message || e));
            setResult({ error: String(e.message || e) });
        }
    }

    function clearResult(){
        setResult({});
    }

    function clearHistory(){
        history.length = 0;
        setHistory();
        toast("warn","History cleared","Order history cleared.");
    }

    // ---- Service checks ----
    async function checkServices(){
        // Product check: GET /products
        try{
            const r = await fetch(PRODUCT_URL, { method:"GET" });
            setDot("dotProduct", r.ok ? "ok" : "bad");
        }catch{ setDot("dotProduct","bad"); }

        // Order check: we can't safely probe without creating an order, so just mark as "warn" (running is assumed if UI loads from it).
        // If you want strict checks, add /health endpoint later.
        setDot("dotOrder","warn");

        // Payment check: POST dummy request (NOTE: it will create a simulated payment)
        try{
            const r = await fetch(PAYMENT_URL, {
                method:"POST",
                headers:{ "Content-Type":"application/json" },
                body: JSON.stringify({ orderId: "ping", amount: 0 })
            });
            setDot("dotPayment", r.ok ? "ok" : "bad");
        }catch{ setDot("dotPayment","bad"); }

        toast("ok","Service check done","Updated service status indicators.");
    }

    // ---- Security helpers ----
    function escapeHtml(str){
        return String(str ?? "").replace(/[&<>"']/g, s => ({
            "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
        }[s]));
    }
    function escapeJs(str){
        // minimal safe embedding into single-quoted attribute context
        return String(str ?? "").replace(/\\/g,"\\\\").replace(/'/g,"\\'");
    }

    // ---- Init ----
    (function init(){
        setResult({});
        setHistory();
        renderCart();
        loadProducts();
        // Order dot: if UI is served by order-service, it's likely up
        setDot("dotOrder","ok");
        // Payment dot unknown until check or order
        setDot("dotPayment","warn");
    })();
</script>
</body>
</html>
